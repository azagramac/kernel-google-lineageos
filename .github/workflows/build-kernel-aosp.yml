name: üöÄ Build Android Kernel for Pixel

on:
  workflow_dispatch:
    inputs:
      aosp_repo:
        description: 'üìÇ Repo Android Kernel Manifest'
        required: true
        default: 'https://android.googlesource.com/kernel/manifest'
        type: choice
        options:
          - https://android.googlesource.com/kernel/manifest
          - https://github.com/LineageOS/android_kernel_google_gs-6.1_manifest
      aosp_branch:
        description: 'üå± Branch repo'
        required: true
        default: 'android-gs-tangorpro-6.1-android16'
      codename:
        description: 'üì± Codename device'
        required: true
        default: 'tangorpro'
      mode_build:
        description: '‚öôÔ∏è Bazel build config'
        required: true
        default: 'pixel_debug_common'
        type: choice
        options:
          - pixel_debug_common
          - kgdb
      kernel_source:
        description: 'üì¶ Kernel package source'
        required: true
        default: 'aosp'
        type: choice
        options:
          - device
          - aosp
          - aosp-staging
      lto_mode:
        description: 'üß¨ LTO mode'
        required: true
        default: 'thin'
        type: choice
        options:
          - none
          - thin
          - full
      avb_key_mode:
        description: 'üîë AVB keys'
        required: true
        default: 'secret'
        type: choice
        options:
          - secret        
          - random
          - none

permissions:
  contents: write

jobs:
  setup:
    name: build-kernel
    runs-on: ubuntu-22.04
    steps:
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üì¶ Install Build Dependencies
        run: |
          echo "üì¶ Installing packages‚Ä¶"
          sudo apt-get update
          sudo apt-get install -y git gnupg flex bison build-essential zip jq curl \
            zlib1g-dev libc6-dev-i386 x11proto-core-dev libx11-dev \
            lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig
          
          echo "üì¶ Installing repo tool‚Ä¶"
          curl https://storage.googleapis.com/git-repo-downloads/repo > repo && chmod a+x repo && sudo mv repo /usr/local/bin/repo
        shell: bash

      - name: üìÇ Download source code
        run: |
          mkdir -p kernel && cd kernel
          echo "üì¶ Installing repo tool‚Ä¶"
          curl https://storage.googleapis.com/git-repo-downloads/repo > repo && chmod a+x repo && sudo mv repo /usr/local/bin/repo
          echo "üå± Sync AOSP..."
          repo init -u ${{ github.event.inputs.aosp_repo }} -b ${{ github.event.inputs.aosp_branch }} --depth=1
          repo sync -c -j4 --no-tags
        shell: bash

      - name: üêß Build Kernel
        id: build
        run: |
          cd kernel
          case "${{ github.event.inputs.kernel_source }}" in
            aosp)
              KERNEL_PACKAGE="@//aosp"
              ;;
            aosp-staging)
              KERNEL_PACKAGE="@//aosp-staging"
              ;;
            device)
              KERNEL_PACKAGE=""
              ;;
          esac
          echo "üì± Device Codename: ${{ github.event.inputs.codename }}"
          echo "üìÇ Kernel source: ${{ github.event.inputs.kernel_source }}"
          echo "‚öôÔ∏è Build config: ${{ github.event.inputs.mode_build }}"
          echo "üß¨ LTO: ${{ github.event.inputs.lto_mode }}"
          echo "üì¶ Kernel package: $KERNEL_PACKAGE"
          echo "üîë AVB keys: ${{ github.event.inputs.avb_key_mode }}"

          bash private/devices/google/${{ github.event.inputs.codename }}/build_${{ github.event.inputs.codename }}.sh \
            --config=${{ github.event.inputs.mode_build }} \
            ${KERNEL_PACKAGE:+--kernel_package=$KERNEL_PACKAGE} \
            --lto=${{ github.event.inputs.lto_mode }}
        shell: bash

      - name: üîè Sign and Verify Kernel Images with AVB
        run: |
          cd kernel
          echo "üîê Preparing AVB key‚Ä¶"
          mkdir -p avb
          
          SIGN_OPTION="${{ github.event.inputs.avb_key_mode }}"
          AVB_KEY="avb/avb_private_key.pem"
          DIST="out/${{ github.event.inputs.codename }}/dist"
          
          if [ "$SIGN_OPTION" = "none" ]; then
              echo "‚ö†Ô∏è Skipping AVB signing as requested (none)"
          else
              if [ "$SIGN_OPTION" = "secret" ]; then
                  if [ -z "${{ secrets.AVB_PRIVATE_KEY }}" ]; then
                      echo "‚ùå AVB_PRIVATE_KEY secret not found!"
                      exit 1
                  fi
                  # Evitar saltos de l√≠nea extra
                  printf "%s" "${{ secrets.AVB_PRIVATE_KEY }}" > "$AVB_KEY"
                  echo "‚úÖ Using AVB private key from GitHub secret"
              else
                  echo "üîë Generating random AVB private key (RSA 2048)"
                  openssl genpkey -algorithm RSA -out "$AVB_KEY" -pkeyopt rsa_keygen_bits:2048
              fi
      
              AVBTOOL=$(find . -type f -name avbtool | head -n1)
              echo "Using avbtool: $AVBTOOL"
              echo "DIST: $DIST"
              ls -l $DIST/*.img
      
              declare -A IMAGES=(
                ["boot.img"]="boot"
                ["dtb.img"]="dtb"
                ["dtbo.img"]="dtbo"
                ["vendor_kernel_boot.img"]="vendor_kernel_boot"
                ["system_dlkm.img"]="system_dlkm"
                ["vendor_dlkm.img"]="vendor_dlkm"
              )
      
              declare -A VERIFICATION_RESULTS
              FAILED=0
      
              for img in "${!IMAGES[@]}"; do
                part="${IMAGES[$img]}"
                if [ -f "$DIST/$img" ]; then
                  size=$(stat -c%s "$DIST/$img")
                  echo "üîè Signing $img (partition: $part)"
                  "$AVBTOOL" add_hash_footer \
                    --image "$DIST/$img" \
                    --partition_name "$part" \
                    --key "$AVB_KEY" \
                    --algorithm SHA256_RSA2048 \
                    --dynamic_partition_size \
                    --partition_size $size
      
                  echo "üîç Verifying $img..."
                  "$AVBTOOL" verify_image --image "$DIST/$img" --key "$AVB_KEY"
                  if [ $? -eq 0 ]; then
                    VERIFICATION_RESULTS[$img]="‚úÖ"
                  else
                    VERIFICATION_RESULTS[$img]="‚ùå"
                    FAILED=1
                  fi
                else
                  echo "‚ö†Ô∏è Skipping $img (not found)"
                  VERIFICATION_RESULTS[$img]="‚ö†Ô∏è"
                fi
              done
      
              echo "üìã AVB Verification Summary:"
              for img in "${!IMAGES[@]}"; do
                echo "- $img : ${VERIFICATION_RESULTS[$img]}"
              done
      
              if [ $FAILED -eq 1 ]; then
                echo "‚ùå Some images failed AVB verification. Stopping workflow."
                exit 1
              fi

              echo "‚ÑπÔ∏è Info for $img:"
                  "$AVBTOOL" info_image --image "$DIST/$img\n"
          fi
        shell: bash

      - name: üì¶ Upload ${{ github.event.inputs.codename }} Kernel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-${{ github.run_number }}
          name: kernel ${{ github.event.inputs.aosp_branch }} for ${{ github.event.inputs.codename }}
          body: |
            ## üìã Kernel Build Summary

            | Item | Value |
            |------|-------|
            | üì± Device Codename | ${{ github.event.inputs.codename }} |
            | üì¶ Kernel source | ${{ github.event.inputs.aosp_repo }} |
            | ‚öôÔ∏è Build config | ${{ github.event.inputs.mode_build }} |
            | üß¨ LTO | ${{ github.event.inputs.lto_mode }} |
            | üîë AVB keys | ${{ github.event.inputs.avb_key_mode }} |

          files: kernel/out/${{ github.event.inputs.codename }}/dist/*.img
          overwrite_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
